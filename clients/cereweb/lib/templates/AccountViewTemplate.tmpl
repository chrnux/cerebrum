## Copyright 2004, 2005 University of Oslo, Norway
##
## This file is part of Cerebrum.
##
## Cerebrum is free software; you can redistribute it and/or modify it
## under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## Cerebrum is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Cerebrum; if not, write to the Free Software Foundation,
## Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

#extends EntityViewTemplate

#from lib.utils import spine_to_web
#from lib.utils import quotedate
#from lib.utils import url_quote
#from lib.utils import entity_link
#from lib.utils import make_acronym

#from Widgets import Widgets
#attr $widgets = Widgets()

#from FormWidgets import FormWidgets
#attr $form_widgets = FormWidgets()

#def title()
    #return $_('Account %s') % $spine_to_web($account.name)
#end def

#def actions()
<div id="actions">
    <h3>$_('Actions')</h3>
    <ul>
        <li><a href="/confirm/account/update?account_id=$account.id">
                    $_('Refresh')</a></li>
        <li><a href="/confirm/account/randpassword?id=$account.id">
                    $_('Generate password')</a></li>
        <li><a href="/entity/full_historylog?id=$account.id">
            $_('Recent changes')</a> </li>
    </ul>

    #if $is_admin
        <h3 class="admin_actions">$_('Admin actions')</h3>
        <ul>
            #if $account.is_posix
                <li><a href="/confirm/account/demote_posix?account_id=$account.id">$_("Demote from posix")</a></li>
            #else
                <li><a href="/confirm/account/promote_posix?account_id=$account.id">$_("Promote to posix")</a></li>
            #end if
            <li><a href="/confirm/account/delete?account_id=$account.id">$_("Delete")</a></li>
        </ul>
    #end if
</div>
#end def

#def content()
    $editAccount($account)
    $viewInfo($account)
    $viewQuarantines($account)
    $addQuarantine($account, $quarantines)
    $addNote($account)
    $viewNotes($account)
    $viewSpreads($account)
    $viewAffiliation($account)
    $viewEmail($account)
    $viewGroups($account)
    $joinGroup($account)
    $addAffiliation($account)
    $setEmail($account)
    $setPassword($account)
    $viewTraits($account)
    $setHomeDirectory($account)
    $viewHomeDirectories($account)
    $addSpread($account, $spreads)
    $viewPasswords($account)
    $viewHistoryLog($account)
#end def

#def viewInfo($account)
    #set $info = []
    #set $notice = []

    #if $account.is_quarantined
        $notice.append($_("This account has been quaranteened"))
    #end if

    #if $account.is_expired
        $notice.append($_("This account has expired."))
    #end if

    $info.append(($_('Name'), $spine_to_web($account.name)))
    $info.append(($_('Owned by'), $entity_link($account.owner)))
    $info.append(($_('Expire date'), $quotedate($account.expire_date)))
    $info.append(($_('Date created'), $quotedate($account.create_date)))
    $info.append(($_('Created by'), $entity_link($account.creator)))

    #if $account.np_type
        $info.append(($_('Account type'), $spine_to_web($account.np_type_name)))
    #end if
    #if $account.is_posix
        #set $text=$make_acronym($_('User identification (numerical id. used by UNIX-systems)'),$_('User ID'))
        $info.append(($text, $account.posix_uid))
        $info.append(($_('Primary group'), $entity_link($account.primary_group)))
        #set $text=$make_acronym($_('General information about this user (used by UNIX-systems and value is usually realname)'), $_('Gecos'))
        $info.append(($text, $spine_to_web($account.gecos)))
        #set $text=$make_acronym($_('The program that provides text-only user-interface for UNIX-systems.'), $_('Shell'))
        $info.append(($text, $spine_to_web($account.shell)))
    #end if

    $widgets.viewInfo($info, $notice)
#end def

#def editAccount($account)
    #set help = ["* Format: YYYY-MM-DD"]
    <div class="edit box" style="display:none;">
        <h3>$_('Edit')</h3>
        <form action="/account/save" method="post">
            <div class="hidden">
                <input type="hidden" name="id" value="$account.id" />
            </div>
            <div class="optional">
                <label for="expire_date">Expire date *:</label>
                <input  type="text" name="expire_date" id="expire_date" value="$quotedate($account.expire_date)" />
            </div>
            #if $account.is_posix
                #set $shells = [($s.name, $s.name) for $s in $shells]
                #set $groups = [($g.id, $g.name) for $g in $account.groups if $g.is_posix]

                <div class="required">
                     $form_widgets.generate_loption($_('group'), $_('Primary group'), $groups, $account.primary_group.id)
                </div>
                <div class="optional">
                    <label for="gecos">Gecos:</label>
                    <input class="optional" type="text" name="gecos" id="gecos" value="$spine_to_web($account.gecos)"/>
                </div>
                <div class="required">
                    $form_widgets.generate_loption($_('shell'), $_('Shell'), $shells, $account.shell)
                </div>
            #end if
            $form_widgets.showHelp($help)
            <div class="buttons">
                <input type="submit" value="$_('Add')" />&#x0020;
                <input type="button" value="$_('Cancel')" class="cancel" />
            </div>
        </form>
    </div>
#end def

#def viewAffiliation($account)
    #if $account.affiliations
    <div class="info box">
        #set $h3=$make_acronym($_('How a person is officially connected to an organization.'), $_('Affiliations'))
        <h3>$h3</h3>
        <table>
            <tr class="headers">
                <th>$_('Affiliation')</th>
                <th>$_('Organization')</th>
                <th>$_('Priority')</th>
                <th>$_('Actions')</th>
            </tr>
            #for $affil in $account.affiliations
                <tr class="item">
                    <td>$spine_to_web($affil.name)</td>
                    <td>$entity_link($affil.ou)</td>
                    <td>$spine_to_web($affil.priority)</td>
                    <td class="actions">
                        #set $args = "account_id=%s&amp;ou_id=%s&amp;affil_id=%s" % (
                            $account.id,
                            $affil.ou.id,
                            $url_quote($affil.id))
                        <a class="action" href="/confirm/account/remove_affil?$args">$_('delete')</a>
                    </td>
                </tr>
            #end for
        </table>
    </div>
    #end if
#end def

#def addAffiliation($account)
    #if not $affiliations
        #return
    #end if

    #set $aff_list = [($spine_to_web("%s:%s" % ($a.affiliation.id, $a.ou.id)),
                       $spine_to_web("%s:%s" % ($a.name, $a.ou.name))) for $a in $affiliations]

    <div class="edit box" style="display:none;">
        <h3 id="affil">$_('Set account affiliation')</h3>
        #if $aff_list
            <form action="add_affil" method="post">
                <div class="hidden">
                    <input type="hidden" name="account_id" value="$account.id" />
                </div>
                <div class="required">
                    $form_widgets.generate_loption("aff_ou", "Affiliation", $aff_list)
                </div>
                <div class="required">
                    $form_widgets.input("priority", "Priority")
                </div>
                <div class="buttons">
                    <input type="submit" value="$_('Set')" />
                    <input type="button" value="$_('Cancel')" class="cancel" />
                </div>
            </form>
        #else
            <p>$_("Can't affiliate the account because the owner is not affiliated.")</p>
        #end if
    </div>
#end def

#def viewPasswords($account)
    #if not $account.authentications
        #return
    #end if

    <div class="info box">
        #set $h3=$make_acronym($_('Password encryption methods for this account.'), $_('Password Encryption Methods'))
        #set $hashes = $spine_to_web(', '.join([$method.name for $method in $account.authentications]))
        <table>
            <tr>
                <th>$h3</th>
            </tr>
            <tr>
                <td>$hashes</td>
            </tr>
        </table>
    </div>
#end def

#def setPassword($account)
#set help = ["Password must be exactly 8 characters long. Must be different from the existing password. Legal chars: [a-z],[A-Z],[0-9] and [!#()*+,.=?@[]_{}~-]. Must contain at least 1 character from 3 of these 4 groups."]
<div class="edit box">
    <h3>$_('Set password')</h3>
    $form_widgets.changePassword($account.id, $help)
</div>
#end def

#def viewHomeDirectories($account)
    #if not $account.homes
        #return
    #end if
    <div class="info box">
    #set $h3=$make_acronym($_('Storage location(s) for the user&apos;s personal files, directories and programs.'),$_('Home Directories'))
    <h3>$h3</h3>
    <table>
        <tr>
            <th>$_('Spread')</th>
            <th>$_('Disk')</th>
            <th>$_('Path')</th>
            <th>$_('Status')</th>
            <th>$_('&nbsp;')</th>
        </tr>
        #for $home in $account.homes
        <tr>
            <td>$spine_to_web($home.spread.name)</td>
            <td>$spine_to_web("%s:%s" % ($home.disk.host.name, $home.disk.path))</td>
            <td>$spine_to_web($home.path)</td>
            <td>$spine_to_web($home.status.description)</td>
            <td><a class="action" href="/confirm/account/remove_home?account_id=$account.id&amp;spread_id=$home.spread.id">$_('Delete')</a></td>
        </tr>
        #end for
    </table>
    </div>
#end def

#def setHomeDirectory($entity)
    <div class="edit box" style="display:none;">
        <h3>$_('Set home directory')</h3>
        <form action="set_home" method="post">
            <div class="hidden">
                <input type="hidden" name="account_id" value="$entity.id" />
            </div>
            <div class="required">
                #set $spreads = [($s.id, $spine_to_web($s.name)) for $s in $entity.spreads]
                $form_widgets.generate_loption("spread_id", "Spread", $spreads, $id="set_spread")
            </div>
            <div class="required">
                $form_widgets.input("path", "Path")
            </div>
            <div class="required">
                #set $disks = [($d.id, $spine_to_web("%s:%s" % ($d.host.name, $d.path))) for d in $disks]
                $disks.insert(0, ("", $_("Not selected")))
                $form_widgets.generate_loption("disk_id", "Disk", $disks)
            </div>
            <div class="buttons">
                <input type="submit" value="$_('Set homedir')" />&#x0020;
                <input type="button" value="$_('Cancel')" class="cancel" />
            </div>
        </form>
    </div>
#end def

#def viewGroups($account)
<div class="info box">
    <h3>$_('Groups')</h3>
    <form action="leave_groups" method="post">
        $listGroups($account)
        <div>
        <input type="hidden" name="account_id" value="$account.id" />
        #if not $account.groups
            $_('Account is not member of any groups')<br />
        #else
            <input type="submit" name="leave" value="$_('Leave group(s)')" />&#x0020;
        #end if
            <a href="/group/create">$_('Create a group')</a>
            <a href="#joinGroupBox">Join existing group</a>
        </div>
    </form>
</div>
#end def
