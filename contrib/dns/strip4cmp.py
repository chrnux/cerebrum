#!/usr/bin/env python2.2

import re
import sys
import getopt
import os

from import_dns import FileParsers
header_splitter = '; AUTOGENERATED: do not edit below this line\n'
zone_postfix = '.uio.no.'

def strip_zone_file(fname, outfname):
    parser = FileParsers()
    parser.prepare_parse_zone_file(fname)
    p = os.popen("sort > %s" % outfname, 'w')
    while True:
        dta = parser.next_zone_entry()
        if not dta:
            break
        if dta[0] != 'contact':
            p.write(str((parser.owner, dta[:-1]))+"\n")
    p.close()

def strip_reverse_file(fname, outfname):
    p = os.popen("sort > %s" % outfname, 'w')
    parser = FileParsers()
    parser.prepare_parse_revmap(fname)
    while True:
        dta = parser.next_revmap()
        if not dta:
            break
        p.write(str(dta)+"\n")
    p.close()

def usage(exitcode=0):
    print """Usage: [options]

    Convert the file to a format suitable for 'diff -u'.

    --help: help
    -i filename: input filename
    -o filename: output filename
    -z convert zonefile
    -r convert reverse map
    """
    sys.exit(exitcode)

def main():
    try:
        opts, args = getopt.getopt(sys.argv[1:], 'i:o:zr', [
            'help',])
    except getopt.GetoptError:
        usage(1)
    if not opts:
        usage(1)

    for opt, val in opts:
        if opt in ('--help', ):
            usage()
        elif opt in ('-i',):
            infile = val
        elif opt in ('-o',):
            outfile = val
        elif opt in ('-z',):
            strip_zone_file(infile, outfile)
        elif opt in ('-r',):
            strip_reverse_file(infile, outfile)

if __name__ == '__main__':
    main()
