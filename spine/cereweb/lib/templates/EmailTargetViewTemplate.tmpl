## Copyright 2004, 2005 University of Oslo, Norway
##
## This file is part of Cerebrum.
##
## Cerebrum is free software; you can redistribute it and/or modify it
## under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## Cerebrum is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Cerebrum; if not, write to the Free Software Foundation,
## Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

#extends EntityViewTemplate
#from lib.utils import object_link, strftime, strftime, html_quote
#from lib.utils import remember_link, url_quote, spine_to_web
#from FormWidgets import FormWidgets
#from Widgets import Widgets
#from urllib import urlencode
#import datetime
#import cherrypy

#attr $form_widgets = FormWidgets()
#attr $widgets = Widgets()

#def unix2date($the_stamp)
#if $the_stamp is not None
#set $the_date = datetime.datetime.fromtimestamp($the_stamp)
$html_quote($strftime($the_date))
#end if
#end def

#def edit_target($target)
<div>
    Vennligst bruk EmailTargetEditTemplate til denne testen.
</div>
#end def

#def actions()
<div id="actions">
    <h3>$_("Actions")</h3>
    #set $id = $url_quote($entity_id)
    #set $referer = $cherrypy.request.headerMap.get('Referer', '')
    #set $ref = $url_quote($referer)
    <a href="edit?id=$id">$_("edit info")</a><br />
    <a href="delete?id=$id&amp;ref=$ref">$_("delete target")</a><br />
    <a href="/entity/full_historylog?id=$id">$_('view full history log')</a>
    <br />
    $remember_link($entity)<br />
</div>
#end def

## Main method for creating the view
#def content()
$viewInfo()
$viewEmailAddresses()
$addEmailAddress()
#end def


#def viewInfo()
#set $info = []
#set $notice = []
#set $id = $entity['id']
#set $primary = $entity['primary']
$info.append(($_('Type'), $html_quote($entity['type'].capitalize())))
$info.append(($_('Owner'), $entity['entity']))
$info.append(($_('Server'), $spine_to_web($entity['server'])))
$info.append(($_('Primary Address'),
  $html_quote($entity['primary']['local']+"@"+$entity['primary']['domain'])))
$widgets.viewInfo($info, $notice)
#end def

#def viewEmailAddresses()
    #set $id = $entity['id']
    #set $addresses = $entity.get('addresses', None)
    <div class="info box">
    <h3>$_('Email Addresses:')</h3>
        #if $addresses
            <table>
                <tr>
		<th>$_('Address')</th>
		<th>$_('Created')</th>
		<th>$_('Changed')</th>
		<th>$_('Expires')</th>
                </tr>
                #for $addr in $addresses
                    #if $addr['primary']
                    <tr class="primary item">
		    #else
		    <tr class="item">
		    #end if
			<td>
			    $html_quote($addr['local']+"@"+$addr['domain'])
                        </td>
			<td>$unix2date($addr['created'])</td>
			<td>$unix2date($addr['changed'])</td>
			<td>$unix2date($addr['expire'])</td>
                        <td>
                            #set $address = $addr['id']
                            <a class="action" href="/emailtarget/delete_addr?id=$url_quote($id)&amp;addr=$url_quote($address)">Delete</a>
			    #if not $addr['primary']
                            <a class="action" href="/emailtarget/setprimary?id=$url_quote($id)&amp;addr=$url_quote($address)">Primary</a>
			    #end if
                        </td>
                    </tr>
                #end for
            </table>
        #else
            <div>No addresses</div>
        #end if
    </div>
#end def

#def addEmailAddress
    #set $id = $entity['id']
    <div class="info box">
        <h3>$_('Add a new email address:')</h3>
        <form action="/emailtarget/makeaddress" method="post">
            <input type="hidden" name="id" value="$html_quote($id)" />
            <div>
                $form_widgets.input('local', 'Local',value='')
            </div>
            <div>
                ## $form_widgets.input('domain', 'Domain', value='')
                $form_widgets.generate_loption('domain', 'Domain', $domains)
            </div>
            <div>
                $form_widgets.input('expire', 'Expire*', value='')
            </div>
            <div>
                #set $help = ["* Expire: YYYY-MM-DD"]
                $form_widgets.showHelp($help)
            </div>
            <div>
                <input type="submit" value="$_('Create')" />&#x0020;
                <input type="reset" value="$_('Clear')" />
            </div>
        </form>
    </div>
#end def
