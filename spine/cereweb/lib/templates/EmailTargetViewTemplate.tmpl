## Copyright 2004, 2005 University of Oslo, Norway
##
## This file is part of Cerebrum.
##
## Cerebrum is free software; you can redistribute it and/or modify it
## under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## Cerebrum is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Cerebrum; if not, write to the Free Software Foundation,
## Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

#extends EntityViewTemplate
#from lib.utils import object_link, strftime, strftime
#from lib.WorkList import remember_link
#from FormWidgets import FormWidgets
#import datetime
#import cherrypy

#attr $form_widgets = FormWidgets()

#def unix2date($the_stamp)
#set $the_date = datetime.datetime.fromtimestamp($the_stamp)
$strftime($the_date)
#end def

#def edit_target(target)
#set $id = $target['id']
<div class="view_content">
    ## Actions
    <div class="view_actions">
        <h4>$_('Actions')</h4>
        <div class="actions">
            <a href="edit?id=$id">$_("edit info")</a><br />
            <a href="delete?id=$id">$_("delete account")</a><br />
            <a href="/entity/full_historylog?id=$id">$_('view full history log')</a>        
            <br />
            $remember_link($target)<br />
        </div>
    </div>
    <p>dette er en test</p>
</div>
#end def

## Main method for creating the view
#def view($target, $domains)
#set $id = $target['id']
#set $referer = cherrypy.request.headerMap.get('Referer', '/')
<div class="view_content">

    ## Actions
    <div class="view_actions">
        <h4>$_('Actions')</h4>
        <div class="actions">
            <a href="edit?id=$id">$_("edit info")</a><br />
            <a href="delete?id=$id&amp;ref=$referer">$_("delete target")</a><br />
            <a href="/entity/full_historylog?id=$id">$_('view full history log')</a>
            <br />
            $remember_link($target)<br />
        </div>
    </div>

    ## Content
    #set $primary = $target['primary']
    #set $addresses = $target.get('addresses', None)

    <div class="view_info">
        <h3>$_('Email addresses:')</h3>
        <div>
            <strong><em>$_('Type:')</em></strong>&nbsp;
                    $target['type'].capitalize()
        </div>
        <div>
            <strong><em>$_('Owner:')</em></strong>&nbsp;
                    $target['entity']
        </div>
        <h4>$_('Primary address:')</h4>

        #if $primary
            <table>
                <tr>
                #for $key,$value in $primary.items()
                    #if not $key == 'id' and not $key == 'primary'
                        <th> $key.capitalize() </th>
                    #end if
                #end for
                </tr>
                <tr>
                #for $key,$value in $primary.items()
                    #if not $key == 'id' and not key == 'primary'
                        <td>
                            #if $value
                                #if $key == 'created' or $key == 'changed' or $key == 'expire'
                                    $unix2date($value)
                                #else
                                    $value
                                #end if
                            #end if
                        </td>
                    #end if
                #end for
                    <td>
                        #set $addressid = $primary['id']	
                        <div class="actions">
                            <a href="/emailtarget/delete_addr?id=$id&amp;addr=$addressid">Delete</a>
                        </div>
                    </td>
                </tr>
            </table>
        #else
            <div>$_('No primary address.')</div>
        #end if

        <h4>$_('Additional addresses:')</h4>
        #if $addresses
            <table>
                <tr>
                    #for $key,$values in $addresses[0].items()
                        #if not $key == 'id' and not $key == 'primary'
                            <th> $key.capitalize() </th>
                        #end if
                    #end for
                </tr>
                #for $addr in $addresses
                    #if not $addr['primary']
                        <tr>
                            #for $key,$value in $addr.items()
                                #if not $key == 'id' and not $key == 'primary'
                                <td>
                                    #if $value
                                        #if $key == 'created' or $key == 'changed' or $key == 'expire'
                                            $unix2date($value)
                                        #else
                                            $value
                                        #end if
                                    #end if
                                </td>
                                #end if
                            #end for
                            <td>
                                <div class="actions">
                                    #set $address = $addr['id']
                                    <a class="action" href="/emailtarget/delete_addr?id=$id&amp;addr=$address">Delete</a>&nbsp;
                                    <a class="action" href="/emailtarget/setprimary?id=$id&amp;addr=$address">Primary</a>
                                </div>
                            </td>
                        </tr>
                    #end if
                #end for
            </table>
            #else
                <p>No additional addresses</p>
            #end if
        </table>
    </div>

    <div class="create">
    <h3>$_('Add a new email address:')</h3>
        <form action="/emailtarget/makeaddress" method="post">
            <input type="hidden" name="id" value="$id">
            <div>
                $form_widgets.input('local', 'Local',value='')
            </div>
            <div>
                ## $form_widgets.input('domain', 'Domain', value='')
                $form_widgets.generate_loption('domain', 'Domain:', $domains)
            </div>
            <div>
                $form_widgets.input('expire', 'Expire*', value='')
            </div>
            <div>
                #set $help = ["* Expire: YYYY-MM-DD"]
                $form_widgets.showHelp($help)
            </div>
            <div>
                <input type="submit" value="$_('Create')" />&nbsp;
                <input type="reset" value="$_('Clear')" />
            </div>
        </form>
    </div>
</div>
#end def
