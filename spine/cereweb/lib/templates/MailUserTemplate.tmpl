## Copyright 2004, 2005 University of Oslo, Norway
##
## This file is part of Cerebrum.
##
## Cerebrum is free software; you can redistribute it and/or modify it
## under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## Cerebrum is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Cerebrum; if not, write to the Free Software Foundation,
## Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

#from FormWidgets import FormWidgets
#from UserTemplate import UserTemplate
#from time import gmtime, strftime
#from lib.utils import html_quote, url_quote, spine_to_web
#extends UserTemplate

#attr $form_widgets = FormWidgets()
#attr $a_week = 604800

#def viewTargets($targets)
    <div class="view view_info" id="targets_view" style="display:always;">
    <table>
        <tr>
            <th colspan="2">
                <div class="tableheader">
                    Targets:
                </div>
            </th>
        </tr>
        #for $target in $targets
        #set $target_id = $url_quote($target.get_id())
        <tr>
            <td>
                <div class="item">
                    <h3>$pine_to_web($target.get_target_type().get_name())$_('@')$spine_to_web($target.get_server().get_name())</h3>
                </div>
            </td>
            ##<td>
            ##    &#x0020;
            ##</td>
        <tr>
            <td>
                <div class="td_lead_info">
                Primary address:&#x0020;
                #if $target.get_primary_address()
                    $spine_to_web($target.get_primary_address().full_address())
                #else
                    no primary address
                #end if
                </div>
            </td>
            ##<td>
            ##    &#x0020;
            ##</td>
        </tr>
        </tr>
        #if $target.get_vacations()
        <tr>
            <td>
                <div class="item"
                <table>
                    <tr>
                        <th colspan="2" align="left">
                            Vacations:
                         </th>
                    </tr>
                    #for $vac in $target.get_vacations()
                    <tr>
                        <td>
                            Start:
                        </td>
                        <td>
                            $html_quote($vac.get_start_date().strftime('%Y-%m-%d'))
                        </td>
                    </tr>
                    <tr>
                        <td>
                            End:
                        </td>
                        <td>
                            $html_quote($vac.get_end_date().strftime('%Y-%m-%d'))
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Text:
                        </td>
                        <td>
                            $spine_to_web($vac.get_vacation_text())
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Enabled:
                        </td>
                        <td>
                            #if $vac.get_enable()
                                True
                            #else
                                False
                            #end if
                        </td>
                    </tr>
                    <tr>
                        <td>
                            #set $start_date = $url_quote($vac.get_start_date().strftime('%Y-%m-%d'))
                            <a href="/user_client/delete_vacation?id=$target_id&amp;start=$start_date">Delete vacation</a>
                        </td>
                        <td>
                            &#x0020;
                        </td>
                    </tr>
                    #end for
                </table>
            </td>
            ##<td>
            ##    &#x0020;
            ##</td>
        </tr>
        #end if
        <tr>
            <td>
                &#x0020;
            </td>
            ##<td>
            ##    &#x0020;
            ##</td>
        </tr>
        #if $target.get_forwards()
        <tr>
            <td>
            <div class="item">
                <table>
                    <tr>
                        <th colspan="2" align="left">
                            Forwards:
                        </th>
                    </tr>
                    #for $fwd in $target.get_forwards()
                    <tr>
                        <td>
                            Forward to:
                        </td>
                        <td>
                            $spine_to_web($fwd.get_forward_to())
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Enabled:
                        </td>
                        <td>
                            #if $fwd.get_enable()
                                True
                            #else
                                False
                            #end if
                        </td>
                    </tr>
                    <tr>
                        <td>
                            #set $forward_to = $url_quote($fwd.get_forward_to())
                            <a href="/user_client/delete_forward?id=$target_id&amp;forward=$forward_to">Delete forward</a>
                        </td>
                        <td>
                            &#x0020;
                        </td>
                    </tr>
                    #end for
                </table>
            </div>
            </td>
            ##<td>
            ##    &#x0020;
            ##</td>
        </tr>
        #end if
        #end for
    </table>
    </div>
#end def

#def viewVacation($account, $vacations)
<div>
## <div class="view_vacation" id="vacation_view" style="display:always;">
<div class="view view_info" style="display:always;">
<table width="100%">
	<tr>
		<th colspan="2">
			<div class="tableheader">
				Vacations:
			</div>
		</th>
	</tr>
#if $vacations
    #for $vacation in $vacations
    <span class=#if $vacation['enabled']==1 then "enabled" else "disabled" #>
	<tr>
		<td>
			<div class="td_lead_info">
				Start:
			</div>
		</td>
		<td>
			<div class="item">
				$html_quote($vacation['start_date'])
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class="td_lead_info">
				End:
			</div>
		</td>
		<td>
			<div class="item">
				$html_quote($vacation['end_date'])
			</div>
		</td>
        <tr>
                <td>
                        <div class="td_lead_info">
                            Target
                        </div>
                </td>
                <td>
                        <div>
                            $spine_to_web($vacation['target_type'])$_('@')$spine_to_web($vacation['server_name'])
                        </div>
                </td>
        </tr>
	<tr>
		<td>
			<div class="td_lead_info">
				Message:
			</div>
		</td>
		<td>
			<div class="item">
				$spine_to_web($vacation['text'])
			</div>
	</tr>
	<tr>
		<td colspan="2">
			<div class="item">
				<a href=#delete?id=$url_quote($vacation['id'])> Delete </a>&#x0020;
				<a href=#change?id=$url_quote($vacation['id'])> Edit </a>&#x0020;
				<a href=#disable?id=$url_quote($vacation['id'])> Disable </a>
			</div>
		</td>
	</tr>
    </span>
    #end for
#else
	<tr>
    	<td colspan="2">
			<div class="item">
				No vacations registered.
			</div>
		</td>
	</tr>
#end if
##	<tr>
##		<td colspan="2">
##			<div class="item">
##				<a href="#newVacation">Set new vacation</a>
##			</div>
##		</td>
##	</tr>
</table>
</div>
</div>
#end def

#def viewMailForward($forwards)
<div>
## <div class="view_mailforward" id="mailforward_view" style="display:always;">
<div class="view view_info" id="mailforward_view" style="display:always;">
<table width="100%">
	<tr>
		<th colspan="2">
			<div class="tableheader">
				Forwards:
			</div>
		</th>
	</tr>
#if $len($forwards) > 0
    #for $forward in $forwards
    <span class=#if $forward['enabled']==1 then "enabled" else "disabled" #>
	<tr>
		<td>
			<div class="td_lead_info">
        		Start:
			</div>
		</td>
		<td>
			<div class="item">
				$html_quote($forward['start_date'])
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class="td_lead_info">
        End:
			</div>
		</td>
		<td>
			<div class="item">
				$html_quote($forward['end_date'])
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class="td_lead_info">
        		Target:
			</div>
		</td>
		<td>
			<div class="item">
				$spine_to_web($forward['address'])
			</div>
		</td>
	</tr>
	<tr>
		<td colspan="2">
			<div class="item">
				<a href=#delete?id=$url_quote($forward['id'])> Delete </a>&#x0020;
				<a href=#change?id=$url_quote($forward['id'])> Edit </a>&#x0020;
				<a href=#disable?id=$url_quote($forward['id'])> Delete </a>
			</div>
		</td>
	</tr>
    </span>
    #end for
#else
	<tr>
		<td colspan="2">
			<div class="item">
				No forwards registered
			</div>
		</td>
	</tr>
#end if
##	<tr>
##		<td colspan="2">
##			<div class="item">
##				<a href=#newForward>Set new forward</a>
##			</div>
##		</td>
##	</tr>
</table>
</div>
</div>
#end def

#def getTargets($emailtargets)
#set $targets = []
#for $target in $emailtargets
    #set $id = $html_quote($target.get_id())
    #set $type = $spine_to_web($target.get_target_type().get_name())
    #set $host = $spine_to_web($target.get_server().get_name())
    #set $target_name = "%s@%s" % ($type, $host)
    $targets.append(($id, $target_name))
#end for
#return $targets
#end def

#def createVacation($emailtargets)
#set $start = $html_quote($strftime('%Y-%m-%d', gmtime()))
#set $end = ''
#set $alias = ''
#set $targets = $getTargets($emailtargets)
<div class="edit box" >
    <h3>$_('Add a vacation')</h3>
        #if $targets
        <form action="/user_client/add_vacation" method="post">
            <div class="required">
                $form_widgets.input("start", "Start", $start)
            </div>
            <div class="required">
                $form_widgets.input("end", "End", $end)
            </div>
            <div class="required">
                $form_widgets.input("alias", "Alias", $alias)
            </div>
            <div class="required">
                $form_widgets.generate_loption("target","Email target", $targets)
            </div>
            <div class="buttons">
                <input type="submit" name="create" value="$_('Create')" />&#x0020;
                <input type="button" class="cancel" value="$_('Cancel')" />
            </div>
        </p>
        </form>
        #else
        <form action="/user_client/mail" method="post">
            <div class="required">
                $_('You do not have any email-addresses. Cannot add vacation without an email-address.')
            </div>
            <div class="buttons">
                <input type="button" class="cancel" value="$_('Ok')" />
            </div>
        </form>
        #end if
</div>
#end def

#def createMailForward($emailtargets)
#set $start = $html_quote($strftime('%Y-%m-%d', gmtime()))
#set $end = ''
#set $forward = ''
#set $targets = $getTargets($emailtargets)
<div class="edit box" >
    <h3>$_('Add a forward')</h3>
        #if $targets
        <form action="/user_client/add_forward" method="post">
            <div class="required">
                $form_widgets.input("forward", "Forward", $forward)
            </div>
            <div class="required">
                $form_widgets.generate_loption("target","Email target", $targets)
            </div>
            <div class="buttons">
                <input type="submit" name="create" value="$_('Create')" />&#x0020;
                <input type="button" class="cancel" value="$_('Cancel')" />
            </div>
        </p>
        </form>
        #else
        <form action="/user_client/mail" method="post">
            <div class="required">
                $_('You do not have any email-addresses. Cannot add forward without an email-address.')
            </div>
            <div class="buttons">
                <input type="button" class="cancel" value="$_('Ok')" />
            </div>
        </form>
        #end if
</div>
#end def

#def content()
<div class="view_content">
    $viewInfo($account)
    $viewTargets($emailtargets)
    ## $viewVacation($account, $vacations)
    ## $viewMailForward($forwards)
    $createVacation($emailtargets)
    $createMailForward($emailtargets)
</div>
#end def
