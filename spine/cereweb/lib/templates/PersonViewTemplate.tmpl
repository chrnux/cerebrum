## Copyright 2004, 2005 University of Oslo, Norway
##
## This file is part of Cerebrum.
##
## Cerebrum is free software; you can redistribute it and/or modify it
## under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## Cerebrum is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Cerebrum; if not, write to the Free Software Foundation,
## Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.

#extends EntityViewTemplate

#from lib.utils import entity_link, strftime, html_quote, quotedate
#from lib.utils import url_quote, create_ou_selection_tree, nl2br
#from lib.utils import web_to_spine, spine_to_web
#from lib.utils import get_lastname_firstname
#import operator
#from Widgets import Widgets

#attr $widgets = Widgets()
#attr $names_width = 5
#attr $viewBirthNo = False

#attr $page = "person"
#attr $link = "view"

#def title()
    #return $_('Person %s') % $spine_to_web($person.name)
#end def

#def links()
    #return (
        ('search', $_('Search')),
        ('create', $_('Create')),
    )
#end def

#def actions()
<div id="actions">
    <h3>$_('Actions')</h3>
    <ul>
        <li><a href="/person/edit?id=$person.id">$_("edit info")</a></li>
        <li><a href="/confirm/person/delete?id=$person.id">$_("delete person")</a></li>
        <li><a href="/account/create?owner_id=$person.id">$_('create new account')</a></li>
        <li><a href="/entity/full_historylog?id=$person.id">$_('view full history log')</a> </li>
    </ul>
</div>
#end def

## Page for viewing information about a person.
#def content()
    $viewInfo($person)
    $setName($person, $name_types)
    $printDialog($person)
    $viewNames($person)
    $viewQuarantines($person)
    $addQuarantine($person, $quarantines)
    $addNote($person)
    $viewNotes($person)
    $viewAccounts($person)
    $addAffiliation($person)
    $viewAffiliation($person)
    $viewTraits($person)
    $viewContactInfos($person)
    $viewAddresses($person)
    $setExternalId($person, $id_types)
    $viewExternalIds($person, $viewBirthNo)
    $viewHistoryLog($person)
#end def

#def viewInfo($person)
    #set $info = []
    #set $notice = []
    #if $person.is_deceased
        $notice.append($_("Deceased"))
        $info.append(($_("Deceased date"), $quotedate($person.deceased_date)))
    #end if
    $info.append(($_("Name"), $spine_to_web($person.name)))
    $info.append(($_("Gender"), $spine_to_web($person.gender.description)))
    $info.append(($_("Date of birth"), $quotedate($person.birth_date)))
    $info.append(($_("Description"), $spine_to_web($person.description)))
    $widgets.viewInfo($info, $notice)
#end def

#def viewAffiliation($person)
#if not $person.affiliations
    #return
#end if

<div class="info box">
    <h3>$_('Affiliations')</h3>
    <table>
        <tr class="headers">
        <th>$_('Affiliation')</th>
        <th>$_('OU')</th>
        <th>$_('Additional Info')</th>
        <th>$_('Source')</th>
        <th>$_('Actions')</th>
        </tr>
        #set $active = [x for x in $person.affiliations if not x.is_deleted]
        #set $deleted = [x for x in $person.affiliations if x.is_deleted]

        $writeAffiliations($person, $active)
        $writeAffiliations($person, $deleted)
    </table>
</div>
#end def

#def writeAffiliations($person, $affiliations)
#for $aff in $affiliations
#if $aff.is_deleted
    <tr class="item deleted">
#else    
    <tr class="item">
#end if
        <td>$spine_to_web($aff.name)</td>
        <td>$entity_link($aff.ou)</td>
        <td>
        #if not $aff.is_deleted
            $_('active')
        #end if
        </td>
        <td>$spine_to_web($aff.source_system.name)</td>
        <td>
                #set $args = "id=%s&amp;ou=%s&amp;affil=%s&amp;ss=%s" % (
                            $person.id,
                            $aff.ou.id,
                            $aff.id,
                            $aff.source_system.id)
                #if not $aff.is_deleted
                    <a class="action" href="/confirm/person/remove_affil?$args">delete</a>
                #end if
        </td>
    </tr>
#end for
#end def

#def addAffiliation($person)
#set $status = [($s.id, $spine_to_web($s.name)) for $s in $affiliation_types]

#set $ou_options = $create_ou_selection_tree($ou_tree)
<div class="edit box">
    <h3 id="affil">$_('Add an affiliation')</h3>
    <form action="add_affil" method="post">
        <div class="hidden">
            <input type="hidden" name="id" value="$person.id" />
        </div>
        <div class="required">
            $form_widgets.generate_loption("status", "Affiliation", $status)
        </div>
        <div class="required">
            $form_widgets.generate_loption("ou", "Organization Unit", $ou_options, $quote=False)
        </div>
        <div class="buttons">
            <input type="submit" value="$_('Add')" />&#x0020;
            <input type="button" value="$_('Cancel')" class="cancel" />
        </div>
    </form>
</div>
#end def

#def viewNames($person)
    <div class="info box">
        <h3>$_('Names')</h3>
        <table>
            <tr>
              <th>$_('Type')</th>
              <th>$_('Name')</th>
              <th>$_('Sources')</th>
            </tr>
            #for $name in $person.names
            <tr>
               <td>$spine_to_web($name.variant.name)</td>
               <td>$spine_to_web($name.value)</td>
               <td>
                    #for $source in $name.source_systems
                    <div>$spine_to_web($source.name) - <a class="action" href="/confirm/person/remove_name?id=$name.id&amp;variant=$name.variant.id&amp;ss=$source.id">delete</a></div>
                    #end for
               </td>
            </tr>
            #end for
        </table>
    </div>
#end def

#def setName($person, $name_types)
<div class="edit box">
    <h3>$_('Set a name')</h3>
    <form action="add_name" method="post">
        <div class="hidden">
            <input type="hidden" name="id" value="$person.id" />
        </div>
        <div class="required">
            $form_widgets.input("name", "Name")
        </div>
        <div class="required">
            $form_widgets.generate_loption("name_type", "Name type",
                    [($spine_to_web($i.name), $spine_to_web($i.description)) for $i in $name_types])
        </div>
        <div class="buttons">
            <input type="submit" value="$_('Set name')" />&#x0020;
            <input type="button" value="$_('Cancel')" class="cancel" />
        </div>
    </form>
</div>
#end def

#def printDialog($person)
#set $langs= [ ('no', 'Norwegian'),('en', 'English')]
<div class="edit box">
    <h3>$_('Print contract')</h3>
        <form action="print_contract" method="post">
            <div>
            <input type="hidden" name="id" value="$person.id" />
            <div>
                $form_widgets.generate_loption("lang", "Language", $langs)
            </div>
            <div class="buttons">
            <input type="submit" value="$_('Print')" />
            <input type="button" value="$_('Cancel')" class="cancel" />
            </div>
            </div>
        </form>
</div>
#end def
