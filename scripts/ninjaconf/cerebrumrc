#
# Configuration file for Cerebrum, bofh.sh and bofhd.sh.
# The idea is to keep all the configuration in one place.
#
# For Cerebrum/USIT.
#
# Save this file as ~/.cerebrumrc.
#
# A file like ~/.cereconf/uio/cerepath.py will override
# the common configuration.
#
# Changelog:
#   June 2013, Alexander RÃ¸dseth <rodseth@usit.uio.no>
#   July 2013
#

CEREBRUM_PATH=~/checkout/cerebrum
CERECONF_PATH=~/.cerebrum

# If CI is set, use that as CEREBRUM_INST
[ -z "$CI" ] || CEREBRUM_INST="$CI"

# Set CEREBRUM_INST to uio if it's not already set
[ -z "$CEREBRUM_INST" ] && CEREBRUM_INST=uio

# UIO
CEREBRUM_DATABASE_USER_uio=cerebrum
CEREBRUM_DATABASE_HOST_uio=dbpg-cere-utv.uio.no
CEREBRUM_DATABASE_NAME_uio="cerebrum_uio_$USER"
CEREBRUM_DATABASE_TABLE_OWNER_uio=cerebrum

# UIA
CEREBRUM_DATABASE_USER_uia=cerebrum
CEREBRUM_DATABASE_HOST_uia=dbpg-cere-utv.uio.no
CEREBRUM_DATABASE_NAME_uia="cerebrum_uia_$USER"
CEREBRUM_DATABASE_TABLE_OWNER_uia=cerebrum

# For cereconf.py
export CERECONF_GLOBAL="/cerebrum/$CEREBRUM_INST/etc/cerebrum"
eval export CEREBRUM_DATABASE_USER=\$CEREBRUM_DATABASE_USER_$CEREBRUM_INST
eval export CEREBRUM_DATABASE_HOST=\$CEREBRUM_DATABASE_HOST_$CEREBRUM_INST
eval export CEREBRUM_DATABASE_NAME=\$CEREBRUM_DATABASE_NAME_$CEREBRUM_INST
eval export CEREBRUM_DATABASE_TABLE_OWNER=\$CEREBRUM_DATABASE_TABLE_OWNER_$CEREBRUM_INST

# CEREBRUM
# Don't set this to your home directory, preferrably get a dedicated directory
# on cere-utv01 just to store the logs.
LOGGING_ROOT_DIR=/tmp

# PYTHON
if [[ "$PY" == "26" ]]; then
  # Use Python 2.6 if PY=26
  PYTHON_BIN=/usr/bin/python2.6
  PYTHON_LIBRARY_PATH=/local/lib
  PYTHON_EXTERNAL=$CEREBRUM_PATH/scripts/ninjaconf/external/python2.6
  export LD_LIBRARY_PATH=$PYTHON_LIBRARY_PATH:$LD_LIBRARY_PATH
else
  # Use Python 2.5 by default
  PYTHON_BIN=/local/bin/python
fi

# Check if the Python interpreter can be found
if [[ ! -e "$PYTHON_BIN" ]]; then
  echo -e "\e[97mCould not find: \e[91m$PYTHON_BIN\e[0m"
  exit 1
fi
PYTHON_VERSION=`$PYTHON_BIN --version 2>&1 | cut -d' ' -f2`
SHORT_PYTHON_VERSION="${PYTHON_VERSION%.*}"
SHORTER_PYTHON_VERSION="${SHORT_PYTHON_VERSION/./}"

# Check if /cerebrum exists
if [[ ! -d /cerebrum ]]; then
  echo -e "\e[97mNo such directory: \e[91m/cerebrum\e[0m"
  exit 1
fi

# PYTHONPATH
CERECONF_COMMON=$CERECONF_PATH/common
PYTHON_SITE_PACKAGES=/site/lib/python2.5/site-packages
PYTHON_CEREBRUM_MODULES="$CEREBRUM_PATH"
CERECONF_CUSTOM=$CERECONF_PATH/"$CEREBRUM_INST"
export PYTHONPATH="$PYTHON_SITE_PACKAGES:$CERECONF_CUSTOM:$CERECONF_COMMON:$CERECONF_GLOBAL:$PYTHON_CEREBRUM_MODULES:$PYTHON_EXTERNAL"

# BOFH
BOFH_PROMPT="bofh (py$SHORTER_PYTHON_VERSION) $CEREBRUM_INST"
#BOFH_USER=bootstrap_account
BOFH_USER="$USER"
BOFH_BIN=/local/bin/bofh

# BOFHD
BOFHD_CONFIG_DAT="$CERECONF_PATH/bofhd/config.dat"
BOFHD_PY="$CEREBRUM_PATH/servers/bofhd/bofhd.py"
BOFHD_PORT=1337

# Output various settings
echo
echo -e "\e[92mCerebrum configuration:\e[0m"
echo
echo -e "\t\e[94mInstitution:\e[0m\t\t\e[91m$CEREBRUM_INST\e[0m"
echo -e "\t\e[94mDB user:\e[0m\t\t\e[97m$CEREBRUM_DATABASE_USER\e[0m"
echo -e "\t\e[94mDB host:\e[0m\t\t\e[97m$CEREBRUM_DATABASE_HOST\e[0m"
echo -e "\t\e[94mDB name:\e[0m\t\t\e[97m$CEREBRUM_DATABASE_NAME\e[0m"
echo -e "\t\e[94mDB table owner:\e[0m\t\t\e[97m$CEREBRUM_DATABASE_TABLE_OWNER\e[0m"
echo -e -n "\t\e[94mPython version:\e[0m\t\t\e[96m"
"$PYTHON_BIN" -c "import sys;print(sys.version.split(' ')[0])"
echo -e -n '\e[0m'
echo -e "\t\e[94mPython executable:\e[0m\t\e[93m$PYTHON_BIN\e[0m"
echo -e "\t\e[94mPYTHONPATH:\e[0m\e[90m"
"$PYTHON_BIN" -c "import os;print(os.linesep.join(['\t\t' + x for x in os.getenv('PYTHONPATH').split(':')])[:-3])"
echo -e -n '\e[0m'
echo

# Write config.dat for BOFHD if it doesn't exist
if [ ! -e "$CERECONF_PATH/bofhd/config.dat" ]; then
  mkdir -p "$CERECONF_PATH/bofhd"
  cat << 'EOF' > "$CERECONF_PATH/bofhd/config.dat"
# Config file for bofhd
Cerebrum.modules.no.uio.bofhd_uio_cmds/BofhdExtension
Cerebrum.modules.no.uio.bofhd_guestaccounts_cmds/BofhdExtension
#Cerebrum.modules.no.uio.printer_quota.bofhd_pq_cmds/BofhdExtension
Cerebrum.modules.no.uio.bofhd_ephorte_cmds/BofhdExtension
#Cerebrum.modules.dns.bofhd_dns_cmds/BofhdExtension
#Cerebrum.modules.dns.Subnet/BofhdExtension
EOF
fi

# Write cereconf.py if it doesn't exist
if [ ! -e "$CERECONF_PATH/common/cereconf.py" ]; then
  mkdir -p "$CERECONF_PATH/common"
  cat << 'EOF' > "$CERECONF_PATH/common/cereconf.py"
import sys, os, os.path
execfile(os.path.join(os.getenv('CERECONF_GLOBAL'), 'cereconf.py'))
CEREBRUM_DATABASE_CONNECT_DATA['user'] = os.getenv('CEREBRUM_DATABASE_USER', "DATABASE USER NOT SET")
CEREBRUM_DATABASE_CONNECT_DATA['host'] = os.getenv('CEREBRUM_DATABASE_HOST', "DATABASE HOST NOT SET")
CEREBRUM_DATABASE_NAME = os.getenv('CEREBRUM_DATABASE_NAME', "DATABASE NAME NOT SET")
CEREBRUM_DATABASE_CONNECT_DATA['table_owner'] = os.getenv('CEREBRUM_DATABASE_TABLE_OWNER', "DATABASE TABLE OWNER NOT SET")
BOFHD_SUPERUSER_GROUP = "usit"
EOF
fi
