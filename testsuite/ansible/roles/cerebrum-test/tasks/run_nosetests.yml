# Set up and run tests
#
# Will run tests from the file `nosetests.txt' either in `files/<config>/' or
# `files/'.
#
# The file should contain one test file or test folder per line, relative to
# `<crb_src_dir>/testsuite/tests/'.
# 
# Required vars:
#  - virtualenv
#      Where our virtualenv is. `nosetests' should be installed in the
#      virtualenv.
#  - crb_src_dir
#      The source directory for Cerebrum.
#  - crb_tests  TODO: Not currently in use, should we accept tests from this
#                     variable as well?
#      The test folders/files to run, relative to {{ crb_src_dir }}/testsuite/tests

# TODO: Should we write a module for this?

- name: Place nose config
  template: src={{ item }}
            dest={{ item | tmpfile }}
  with_file_overload:
    - base: 'templates'
    - file: 'noseconfig.j2'
    - alt: '{{ config | default(None) }}'
  register: _noseconfig

# Should we use crb_tests? Maybe do a list join?
#- name: debug tests
  #debug: var=crb_tests

- name: Run test
  action: command {{ virtualenv }}/bin/nosetests 
                  -c {{ _noseconfig | dest }}
                  {{ lookup('file', item) | split | prefix(crb_src_dir + "/testsuite/tests/") | join(" ") }}
  with_file_overload:
    - base: 'files'
    - file: 'nosetests.txt'
    - alt: '{{ config | default(None) }}'
  register: _test_result
  ignore_errors: yes

- name: Write test output
  debug: var=_test_result.stderr
  failed_when: _test_result.rc != 0

