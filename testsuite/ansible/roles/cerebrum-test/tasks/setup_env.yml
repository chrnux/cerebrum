# Set up a virtualenv test environment for Cerebrum.
# 
# Required vars:
#  - virtualenv
#      Where the virtualenv should be placed.
#  - pip_requirements
#      PIP requirements file, decides which packages to install in the
#      virtualenv.
#  - crb_db_name
#      What database to use for the cerebrum test installation.
#  - crb_db_use
#      What postgres-user to use for the crb_db_name.
#  - crb_src_dir
#      The source directory for cerebrum.
#
# Optional vars:
#  - pip_offline
#      Do not download packages, look for the packages in the specified
#      directory, e.g. `pip_offline=/path/to/packages'.
#  - pip_cache
#      Cache downloaded packages in the specified directory for later use, e.g.
#      `pip_cache=/tmp/pip_cache'. Excluded by the pip_offline option.


#
# Set up virtualevn and install packages
#
- name: Decide on PIP offline install
  when: pip_offline is defined
  set_fact: _extra_args="--no-index --find-links={{ pip_offline }}"

- name: Decide on PIP download cache
  when: pip_cache is defined and pip_extra_args is not defined
  set_fact: _extra_args="--download-cache={{ pip_cache }}"

- name: Move requirements file to host
  copy: src={{ item }}
        dest=/tmp/requirements_{{ virtualenv | replace('/', '_') }}.txt
        backup=yes
  with_file_overload:
    - base: 'files'
    - file: 'pip_requirements.txt'
    - alt: '{{ config | default(None) }}'

# TODO: Should we here:
#   - validate that pip_offline exists if defined?
#   - verify that we have the mandatory arguments?
#   - validate that the mandatory arguments makes sense?

- name: Set up test environment
  pip: virtualenv="{{ virtualenv }}"
       requirements=/tmp/requirements_{{ virtualenv | replace('/', '_') }}.txt
       extra_args="{{ _extra_args|default(None) }}"

#
# Drop database
#
#- name: Check database schema difference
  # TODO: How do we do this?!!
  #shell: diff {{ item }} {{ virtualenv }}/share/cerebrum/design/$( basename {{ item }} )
  #register: crb_db_diff_result
  #failed_when: False
  #changed_when: "crb_db_diff_result.rc != 0"
  #with_fileglob:
   #- "{{ crb_src_dir }}/design/*.sql"
  #changed_when: True
  #register: _db_drop
  #
  # TODO/TBD: makedb should work more like `doctrine' - we should be able to
  # just fetch the SQL that would be executed, so that we could test the
  # db-difference.

- name: Drop Cerebrum database
  when: _db_drop is not defined or _db_drop|changed
  postgresql_db: name={{ crb_db_name }}
                 login_user={{ crb_db_user }}
                 state=absent

#
# Install cerebrum
#
- name: Install Cerebrum
  action: command {{ virtualenv }}/bin/python setup.py install --prefix={{ virtualenv }}
          chdir={{ crb_src_dir }}

- name: Locate virtualenv site-packages
  virtualenv_info: env={{ virtualenv }}
                   info=site
  register: _virtualenv_info

# In stead of manipulating the PYTHONPATH, we use the cerebrum_path module
# If we decide to get rid of this in Cerebrum, we'll have to look at how we set
# environment variables with ansible
- name: Place cerebrum_path module
  template: src={{ item }}
            dest={{ _virtualenv_info.site }}/cerebrum_path.py
            validate='{{ virtualenv }}/bin/python -B %s'
  with_file_overload:
    - base: 'templates'
    - file: 'cerebrum_path.j2'
    - alt: '{{ config | default(None) }}'

- name: Place cereconf
  template: src={{ item }}
            dest={{ virtualenv }}/etc/cerebrum/cereconf.py
            validate='{{ virtualenv }}/bin/python -B %s'
  with_file_overload:
    - base: 'templates'
    - file: 'cereconf.j2'
    - alt: '{{ config | default(None) }}'

- name: Place log config
  template: src=logging.j2
            dest={{ virtualenv }}/etc/cerebrum/logging.ini
            validate="python -c \"import ConfigParser;c=ConfigParser.ConfigParser();assert len(c.read(['%s', ]))==1\""
  with_file_overload:
    - base: 'templates'
    - file: 'logging.j2'
    - alt: '{{ config | default(None) }}'

- name: Create dummy file for database password
  template: src={{ item }}
            dest={{ virtualenv }}/etc/cerebrum/passwd-{{ crb_db_user }}@{{ crb_db_name }}@localhost
            validate='grep {{crb_db_user}} %s'
  with_file_overload:
    - base: 'templates'
    - file: 'passwd.j2'
    - alt: '{{ config | default(None) }}'

#
# Create and build database
#
- name: Create Cerebrum database
  postgresql_db: name={{ crb_db_name }}
                 login_user={{ crb_db_user }}
                 owner={{ crb_db_user }}
                 state=present
  register: _db_created


- name: Move extra files to host
  copy: src={{ item }}
        dest="/tmp/extra_files_{{ virtualenv | replace('/', '_') }}.txt"
  register: _extra_files
  with_file_overload:
    - base: 'files'
    - file: 'extra_db_files.txt'
    - alt: '{{ config | default(None) }}'
    - skip: yes

# Note that we use the output from the copy module here, to get the file name,
# and to set extra_files_src to None if we skipped the previous step.
#
# Note that makedb will fail hard if we don't supply any --extra-file arguments.
# This is an error in the Cerebrum design that should probably be fixed...
- name: Create Cerebrum schema with makedb
  makedb: virtualenv={{ virtualenv }}
          extra_files_src={{ item.dest | default(None) }}
  with_items:
    - "{{ _extra_files.results | default(None) }}"  # We copied at most one file
